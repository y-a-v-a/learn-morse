<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Morse Practice</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="data:,">
  <style>
    body {
      font-family: system-ui, sans-serif;
      padding: 1em;
      max-width: 700px;
      margin: auto;
    }
    h1 { font-size: 1.4em; text-align: center; }
    #lessonInfo { text-align: center; margin: 1em 0; font-size: 1.2em; }
    button {
      font-size: 1.2em;
      padding: 0.6em 0.8em;
      margin: 0.3em;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #f8f8f8;
      flex: 1 0 14%;
    }
    #playBtn, #nextBtn {
      width: 100%;
      margin-top: 0.6em;
      font-weight: bold;
      background: #eef;
    }
    #keyboard {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 1em;
    }
    #output {
      margin-top: 1em;
      font-size: 1.3em;
      text-align: center;
      min-height: 2em;
    }

    /* Progress Drawer Styles */
    .progress-section {
      margin-bottom: 1.5em;
      padding: 0.8em;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #007bff;
    }
    .progress-section h3 {
      margin: 0 0 0.8em 0;
      font-size: 1.1em;
      color: #333;
    }
    .char-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3em;
      margin-top: 0.5em;
    }
    .char-item {
      width: 2.2em;
      height: 2.2em;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      font-weight: bold;
      font-size: 0.9em;
      color: white;
    }
    .char-mastered { background: #28a745; }
    .char-learning { background: #ffc107; color: #333; }
    .char-trouble { background: #dc3545; }
    .char-unlearned { background: #6c757d; }

    .history-bar {
      display: flex;
      align-items: end;
      gap: 0.2em;
      height: 50px;
      margin: 0.5em 0;
    }
    .history-day {
      flex: 1;
      background: #e9ecef;
      min-height: 5px;
      border-radius: 2px;
    }
    .history-day.active {
      background: linear-gradient(to top, #007bff 0%, #0056b3 100%);
    }

    .lesson-roadmap {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3em;
      margin-top: 0.5em;
    }
    .lesson-item {
      padding: 0.3em 0.6em;
      border-radius: 15px;
      font-size: 0.8em;
      font-weight: bold;
    }
    .lesson-completed { background: #d4edda; color: #155724; }
    .lesson-current { background: #007bff; color: white; }
    .lesson-upcoming { background: #e2e3e5; color: #6c757d; }

    @media (min-width: 768px) {
      #progressDrawer {
        width: 350px;
        max-width: 350px;
      }
    }
  </style>
</head>
<body>
  <h1>Morse Practice</h1>
  <button id="progressToggle" style="position: absolute; top: 1em; right: 1em; background: #f8f8f8; border: 1px solid #ccc; border-radius: 50%; width: 44px; height: 44px; font-size: 1.2em; cursor: pointer; z-index: 1001; display: flex; align-items: center; justify-content: center;">üìä</button>
  <div id="lessonInfo">
    Lesson <span id="lessonNum"></span>: <span id="chars"></span>
  </div>

  <div id="settings" style="text-align: center; margin: 1em 0; font-size: 0.9em;">
    <div>Overall WPM: <input type="range" id="wpmSlider" min="5" max="20" step="1" style="width: min(150px, 60vw); max-width: 150px;">
    <span id="wpmValue"></span> WPM</div>
    <div style="font-size: 0.8em; color: #666; margin-top: 0.3em;">Character speed: 20 WPM</div>
  </div>

  <div id="progress" style="text-align: center; margin: 1em 0;">
    <div id="sessionStats" style="font-size: 1.1em; margin-bottom: 0.5em;">
      Accuracy: <span id="accuracy">0</span>% (<span id="correctCount">0</span>/<span id="totalCount">0</span> correct)
    </div>
    <div id="progressBar" style="width: 100%; background: #eee; border-radius: 10px; height: 20px; margin: 0.5em 0;">
      <div id="progressFill" style="width: 0%; background: linear-gradient(90deg, #ff6b6b, #feca57, #48dbfb, #0abde3); height: 100%; border-radius: 10px; transition: width 0.3s;"></div>
    </div>
    <div id="advanceInfo" style="font-size: 0.9em; color: #666;">
      Need 90% to advance ‚Ä¢ <span id="estimatedAttempts">0</span> more attempts estimated
    </div>
  </div>

  <button id="playBtn">üîä Play Character</button>
  <div id="keyboard"></div>
  <div id="output"></div>
  <button id="nextBtn">‚û°Ô∏è Next Lesson</button>

  <!-- Progress Drawer -->
  <div id="progressOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;"></div>
  <div id="progressDrawer" style="position: fixed; top: 0; right: -100%; width: 80%; max-width: 350px; height: 100%; background: white; box-shadow: -2px 0 10px rgba(0,0,0,0.3); z-index: 1002; transition: right 0.3s ease; overflow-y: auto;">
    <div style="padding: 1em;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1em; border-bottom: 1px solid #eee; padding-bottom: 0.5em;">
        <h2 style="margin: 0; font-size: 1.3em;">Progress Insights</h2>
        <button id="closeProgress" style="background: none; border: none; font-size: 1.5em; cursor: pointer; padding: 0.2em;">√ó</button>
      </div>

      <div id="progressContent">
        <!-- Session Overview -->
        <div class="progress-section">
          <h3>Current Session</h3>
          <div style="font-size: 1.1em; margin-bottom: 0.5em;">
            <strong>Lesson <span id="drawerLessonNum">1</span></strong>
          </div>
          <div style="margin-bottom: 0.3em;">
            Accuracy: <strong><span id="drawerAccuracy">0</span>%</strong> (<span id="drawerCorrect">0</span>/<span id="drawerTotal">0</span>)
          </div>
          <div style="font-size: 0.9em; color: #666;">
            <span id="drawerEstimate">0</span> attempts to advance
          </div>
        </div>

        <!-- Character Mastery -->
        <div class="progress-section">
          <h3>Character Mastery</h3>
          <div id="characterMastery">
            <!-- Character grid will be populated by JavaScript -->
          </div>
          <div style="margin-top: 0.8em; font-size: 0.8em; color: #666;">
            üü¢ Mastered ‚â•85% ‚Ä¢ üü° Learning ‚â•60% ‚Ä¢ üî¥ Needs Practice &lt;60% ‚Ä¢ ‚ö´ Not Started
          </div>
        </div>

        <!-- Learning History -->
        <div class="progress-section">
          <h3>7-Day Practice History</h3>
          <div id="practiceHistory">
            <div class="history-bar" id="historyChart">
              <!-- History bars will be populated by JavaScript -->
            </div>
            <div style="font-size: 0.8em; color: #666; text-align: center;">
              Last 7 days
            </div>
          </div>
          <div style="margin-top: 0.8em;">
            <div>Total Characters Mastered: <strong><span id="totalMastered">0</span></strong></div>
            <div>Lessons Completed: <strong><span id="lessonsCompleted">0</span></strong></div>
          </div>
        </div>

        <!-- Lesson Roadmap -->
        <div class="progress-section">
          <h3>Koch Method Progress</h3>
          <div id="lessonRoadmap">
            <!-- Lesson items will be populated by JavaScript -->
          </div>
          <div style="margin-top: 0.8em; font-size: 0.9em; color: #666;">
            Next characters to learn: <strong><span id="nextChars">-</span></strong>
          </div>
        </div>

        <!-- Reset Progress -->
        <div class="progress-section" style="border-left-color: #dc3545;">
          <h3>Reset Progress</h3>
          <div style="margin-bottom: 0.8em; font-size: 0.9em; color: #666;">
            This will clear all your progress data, statistics, and reset you back to lesson 1.
          </div>
          <button id="resetProgress" style="background: #dc3545; color: white; border: none; padding: 0.6em 1.2em; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%;">
            üóëÔ∏è Reset All Progress
          </button>
        </div>
      </div>
    </div>
  </div>

<script>
const lessons = [
  ["K","M"], ["K","M","R"], ["K","M","R","S"], ["K","M","R","S","U"],
  ["K","M","R","S","U","A"], ["K","M","R","S","U","A","P"],
  ["K","M","R","S","U","A","P","T"], ["K","M","R","S","U","A","P","T","L"],
  ["K","M","R","S","U","A","P","T","L","O"],
  ["K","M","R","S","U","A","P","T","L","O","W"],
  ["K","M","R","S","U","A","P","T","L","O","W","I"],
  ["K","M","R","S","U","A","P","T","L","O","W","I","N"],
  ["K","M","R","S","U","A","P","T","L","O","W","I","N","J"],
  ["K","M","R","S","U","A","P","T","L","O","W","I","N","J","E"],
  ["K","M","R","S","U","A","P","T","L","O","W","I","N","J","E","F"],
  ["K","M","R","S","U","A","P","T","L","O","W","I","N","J","E","F","0"],
  ["K","M","R","S","U","A","P","T","L","O","W","I","N","J","E","F","0","Y"],
  ["K","M","R","S","U","A","P","T","L","O","W","I","N","J","E","F","0","Y","V"],
  ["K","M","R","S","U","A","P","T","L","O","W","I","N","J","E","F","0","Y","V","G"],
  ["K","M","R","S","U","A","P","T","L","O","W","I","N","J","E","F","0","Y","V","G","5"],
  ["K","M","R","S","U","A","P","T","L","O","W","I","N","J","E","F","0","Y","V","G","5","/"],
  ["K","M","R","S","U","A","P","T","L","O","W","I","N","J","E","F","0","Y","V","G","5","/","Q"],
  ["K","M","R","S","U","A","P","T","L","O","W","I","N","J","E","F","0","Y","V","G","5","/","Q","9"],
  ["K","M","R","S","U","A","P","T","L","O","W","I","N","J","E","F","0","Y","V","G","5","/","Q","9","Z"],
  ["K","M","R","S","U","A","P","T","L","O","W","I","N","J","E","F","0","Y","V","G","5","/","Q","9","Z","H"],
  ["K","M","R","S","U","A","P","T","L","O","W","I","N","J","E","F","0","Y","V","G","5","/","Q","9","Z","H","3"],
  ["K","M","R","S","U","A","P","T","L","O","W","I","N","J","E","F","0","Y","V","G","5","/","Q","9","Z","H","3","8"],
  ["K","M","R","S","U","A","P","T","L","O","W","I","N","J","E","F","0","Y","V","G","5","/","Q","9","Z","H","3","8","B"],
  ["K","M","R","S","U","A","P","T","L","O","W","I","N","J","E","F","0","Y","V","G","5","/","Q","9","Z","H","3","8","B","?"],
  ["K","M","R","S","U","A","P","T","L","O","W","I","N","J","E","F","0","Y","V","G","5","/","Q","9","Z","H","3","8","B","?","4"],
  ["K","M","R","S","U","A","P","T","L","O","W","I","N","J","E","F","0","Y","V","G","5","/","Q","9","Z","H","3","8","B","?","4","2"],
  ["K","M","R","S","U","A","P","T","L","O","W","I","N","J","E","F","0","Y","V","G","5","/","Q","9","Z","H","3","8","B","?","4","2","7"],
  ["K","M","R","S","U","A","P","T","L","O","W","I","N","J","E","F","0","Y","V","G","5","/","Q","9","Z","H","3","8","B","?","4","2","7","C"],
  ["K","M","R","S","U","A","P","T","L","O","W","I","N","J","E","F","0","Y","V","G","5","/","Q","9","Z","H","3","8","B","?","4","2","7","C","1"],
  ["K","M","R","S","U","A","P","T","L","O","W","I","N","J","E","F","0","Y","V","G","5","/","Q","9","Z","H","3","8","B","?","4","2","7","C","1","D"],
  ["K","M","R","S","U","A","P","T","L","O","W","I","N","J","E","F","0","Y","V","G","5","/","Q","9","Z","H","3","8","B","?","4","2","7","C","1","D","6"],
  ["K","M","R","S","U","A","P","T","L","O","W","I","N","J","E","F","0","Y","V","G","5","/","Q","9","Z","H","3","8","B","?","4","2","7","C","1","D","6","X"],
  ["K","M","R","S","U","A","P","T","L","O","W","I","N","J","E","F","0","Y","V","G","5","/","Q","9","Z","H","3","8","B","?","4","2","7","C","1","D","6","X","="],
  ["K","M","R","S","U","A","P","T","L","O","W","I","N","J","E","F","0","Y","V","G","5","/","Q","9","Z","H","3","8","B","?","4","2","7","C","1","D","6","X","=","."],
  ["K","M","R","S","U","A","P","T","L","O","W","I","N","J","E","F","0","Y","V","G","5","/","Q","9","Z","H","3","8","B","?","4","2","7","C","1","D","6","X","=",".",","]
];

let lesson = parseInt(localStorage.getItem("lesson") || "2"); // Start at lesson 3 (K,M,R,S)
let correct = 0, total = 0;
const characterWPM = 20;
let overallWPM = parseInt(localStorage.getItem("overallWPM") || "8");
const dot = 1.2 / characterWPM;
const charSpacing = 3 * dot; // Standard 3-dot spacing between characters
const wordSpacing = 7 * dot; // Standard 7-dot spacing between words
let farnsworthCharSpacing = (60 / (overallWPM * 5)) - (60 / (characterWPM * 5)); // Extra spacing for Farnsworth

// Character accuracy tracking
let charStats = JSON.parse(localStorage.getItem("charStats") || "{}");

// Session history tracking
let sessionHistory = JSON.parse(localStorage.getItem("sessionHistory") || "[]");

function updateCharStats(char, wasCorrect) {
  if (!charStats[char]) {
    charStats[char] = { correct: 0, total: 0 };
  }
  charStats[char].total++;
  if (wasCorrect) charStats[char].correct++;
  localStorage.setItem("charStats", JSON.stringify(charStats));
}

function getCharAccuracy(char) {
  const stats = charStats[char];
  return stats ? (stats.total > 0 ? Math.round((stats.correct / stats.total) * 100) : 0) : 0;
}

function saveSessionData() {
  const sessionData = {
    date: new Date().toISOString().split('T')[0],
    lesson: lesson + 1,
    accuracy: total > 0 ? Math.round((correct / total) * 100) : 0,
    correct: correct,
    total: total,
    overallWPM: overallWPM,
    timestamp: Date.now()
  };

  // Add to session history (keep last 30 sessions)
  sessionHistory.push(sessionData);
  if (sessionHistory.length > 30) {
    sessionHistory = sessionHistory.slice(-30);
  }
  localStorage.setItem("sessionHistory", JSON.stringify(sessionHistory));
}

const morseMap = {
  A: ".-", B: "-...", C: "-.-.", D: "-..", E: ".", F: "..-.",
  G: "--.", H: "....", I: "..", J: ".---", K: "-.-", L: ".-..",
  M: "--", N: "-.", O: "---", P: ".--.", Q: "--.-", R: ".-.",
  S: "...", T: "-", U: "..-", V: "...-", W: ".--", X: "-..-",
  Y: "-.--", Z: "--..",
  "0": "-----","1": ".----","2": "..---","3": "...--","4": "....-",
  "5": ".....","6": "-....","7": "--...","8": "---..","9": "----.",
  "/": "-..-.","?": "..--..","=": "-...-",".": ".-.-.-",",": "--..--"
};

function playMorse(char) {
  const code = morseMap[char];
  if (!code) return;
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.connect(gain); gain.connect(ctx.destination);
  osc.frequency.value = 600; osc.start();
  let t = 0;

  // Play character at full speed
  for (let i = 0; i < code.length; i++) {
    const s = code[i];
    gain.gain.setValueAtTime(1, ctx.currentTime + t);
    t += (s === "." ? dot : 3 * dot);
    gain.gain.setValueAtTime(0, ctx.currentTime + t);
    if (i < code.length - 1) t += dot; // Inter-element spacing
  }

  // Add Farnsworth spacing after character (if overall WPM < character WPM)
  if (overallWPM < characterWPM) {
    t += Math.max(0, farnsworthCharSpacing);
  } else {
    t += charSpacing; // Standard spacing
  }

  osc.stop(ctx.currentTime + t);
}

function updateLesson() {
  document.getElementById("lessonNum").textContent = lesson+1;
  // Hide the character list - students must learn by sound only
  document.getElementById("chars").textContent = `${lessons[lesson].length} characters`;
  updateProgressDisplay();
}

function updateProgressDisplay() {
  const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;
  const progressPercent = Math.min(100, (accuracy / 90) * 100);

  document.getElementById("accuracy").textContent = accuracy;
  document.getElementById("correctCount").textContent = correct;
  document.getElementById("totalCount").textContent = total;
  document.getElementById("progressFill").style.width = progressPercent + "%";

  // Estimate attempts needed to reach 90%
  let estimatedAttempts = 0;
  if (accuracy < 90 && total > 0) {
    const targetCorrect = Math.ceil(0.9 * (total + estimatedAttempts));
    estimatedAttempts = Math.max(0, targetCorrect - correct);
    if (estimatedAttempts === 0) estimatedAttempts = Math.ceil((9 * total - 10 * correct) / 1);
  }

  document.getElementById("estimatedAttempts").textContent = estimatedAttempts;

  // Update color based on accuracy
  const progressFill = document.getElementById("progressFill");
  if (accuracy >= 90) {
    progressFill.style.background = "#0abde3";
  } else if (accuracy >= 70) {
    progressFill.style.background = "#feca57";
  } else {
    progressFill.style.background = "#ff6b6b";
  }
}

function updateWPMDisplay() {
  document.getElementById("wpmSlider").value = overallWPM;
  document.getElementById("wpmValue").textContent = overallWPM;
}

updateLesson();
updateWPMDisplay();
updateCharacterKeyboard();

// WPM slider event handler
document.getElementById("wpmSlider").oninput = (e) => {
  overallWPM = parseInt(e.target.value);
  farnsworthCharSpacing = (60 / (overallWPM * 5)) - (60 / (characterWPM * 5));
  localStorage.setItem("overallWPM", overallWPM);
  updateWPMDisplay();
};

let currentChar = null;
document.getElementById("playBtn").onclick = () => {
  const currentLessonChars = lessons[lesson];
  const previousChars = lesson > 0 ? lessons[lesson - 1] : [];

  // Mix 70% current lesson chars + 30% previous chars for review
  const mixedChars = [...currentLessonChars];
  if (previousChars.length > 0) {
    const reviewCount = Math.max(1, Math.floor(currentLessonChars.length * 0.3));
    for (let i = 0; i < reviewCount; i++) {
      const reviewChar = previousChars[Math.floor(Math.random() * previousChars.length)];
      if (!mixedChars.includes(reviewChar)) {
        mixedChars.push(reviewChar);
      }
    }
  }

  currentChar = mixedChars[Math.floor(Math.random() * mixedChars.length)];
  playMorse(currentChar);
};

// build keyboard
const kb = document.getElementById("keyboard");
for (let c of "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789/?.=,") {
  const b = document.createElement("button");
  b.textContent = c;
  b.id = `key-${c}`;
  b.onclick = () => checkGuess(c);
  kb.appendChild(b);
}

function updateCharacterKeyboard() {
  // Color-code keys based on individual character accuracy
  const currentChars = lessons[lesson];
  for (let c of "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789/?.=,") {
    const key = document.getElementById(`key-${c}`);
    if (!key) continue; // Skip if key doesn't exist

    if (currentChars.includes(c)) {
      const accuracy = getCharAccuracy(c);
      const stats = charStats[c];

      if (!stats || stats.total < 3) {
        // Not enough data - neutral
        key.style.backgroundColor = "#f8f8f8";
      } else if (accuracy >= 85) {
        // Good accuracy - green
        key.style.backgroundColor = "#d4edda";
        key.style.borderColor = "#28a745";
      } else if (accuracy >= 60) {
        // Medium accuracy - yellow
        key.style.backgroundColor = "#fff3cd";
        key.style.borderColor = "#ffc107";
      } else {
        // Poor accuracy - red (needs practice)
        key.style.backgroundColor = "#f8d7da";
        key.style.borderColor = "#dc3545";
      }

      // Add accuracy info to title
      if (stats && stats.total > 0) {
        key.title = `${c}: ${accuracy}% (${stats.correct}/${stats.total})`;
      }
    } else {
      // Reset style for characters not in current lesson
      key.style.backgroundColor = "#f8f8f8";
      key.style.borderColor = "#ccc";
      key.title = "";
    }
  }
}

function checkGuess(g) {
  if (!currentChar) return;
  total++;
  const wasCorrect = g === currentChar;

  if (wasCorrect) {
    correct++;
    document.getElementById("output").textContent = "‚úÖ Correct!";
  } else {
    document.getElementById("output").textContent = `‚ùå Wrong, it was ${currentChar}`;
  }

  updateCharStats(currentChar, wasCorrect);
  updateProgressDisplay();
  updateCharacterKeyboard();
  autoSaveCheck();
  currentChar = null; // reset until next play
}

document.getElementById("nextBtn").onclick = () => {
  const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;
  if (accuracy >= 90 && lesson < lessons.length-1) {
    // Save session data before advancing
    saveSessionData();

    lesson++;
    localStorage.setItem("lesson", lesson);
    correct = 0; total = 0;
    updateLesson();
    updateCharacterKeyboard();
    document.getElementById("output").textContent = "Advanced to next lesson!";
  } else {
    document.getElementById("output").textContent = "Need ‚â•90% accuracy to advance.";
  }
};

// Auto-save session data periodically (every 10 correct answers)
let lastSaveCount = 0;
function autoSaveCheck() {
  if (correct > 0 && correct % 10 === 0 && correct !== lastSaveCount) {
    saveSessionData();
    lastSaveCount = correct;
  }
}

// Progress Drawer Functionality
function toggleProgressDrawer() {
  const drawer = document.getElementById("progressDrawer");
  const overlay = document.getElementById("progressOverlay");

  if (drawer.style.right === "0px") {
    // Close drawer
    drawer.style.right = "-100%";
    overlay.style.display = "none";
  } else {
    // Open drawer and update content
    updateProgressContent();
    drawer.style.right = "0px";
    overlay.style.display = "block";
  }
}

function updateProgressContent() {
  // Update session overview
  document.getElementById("drawerLessonNum").textContent = lesson + 1;
  document.getElementById("drawerAccuracy").textContent = total > 0 ? Math.round((correct / total) * 100) : 0;
  document.getElementById("drawerCorrect").textContent = correct;
  document.getElementById("drawerTotal").textContent = total;

  const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;
  let estimatedAttempts = 0;
  if (accuracy < 90 && total > 0) {
    const targetCorrect = Math.ceil(0.9 * (total + estimatedAttempts));
    estimatedAttempts = Math.max(0, targetCorrect - correct);
    if (estimatedAttempts === 0) estimatedAttempts = Math.ceil((9 * total - 10 * correct) / 1);
  }
  document.getElementById("drawerEstimate").textContent = estimatedAttempts;

  // Update character mastery
  updateCharacterMasteryDisplay();

  // Update practice history
  updatePracticeHistoryDisplay();

  // Update lesson roadmap
  updateLessonRoadmapDisplay();
}

function updateCharacterMasteryDisplay() {
  const container = document.getElementById("characterMastery");
  const currentChars = lessons[lesson];
  const allChars = "KMRSUAPTLOWINJEF0YVG5/Q9ZH38B?427C1D6X=.,";

  let html = '<div class="char-grid">';

  for (let char of allChars) {
    const stats = charStats[char];
    const accuracy = stats ? (stats.total > 0 ? Math.round((stats.correct / stats.total) * 100) : 0) : 0;

    let className = "char-unlearned";
    if (currentChars.includes(char) || (lesson > 0 && lessons[lesson-1] && lessons[lesson-1].includes(char))) {
      if (!stats || stats.total < 3) {
        className = "char-unlearned";
      } else if (accuracy >= 85) {
        className = "char-mastered";
      } else if (accuracy >= 60) {
        className = "char-learning";
      } else {
        className = "char-trouble";
      }
    }

    const title = stats && stats.total > 0 ? `${char}: ${accuracy}% (${stats.correct}/${stats.total})` : `${char}: Not practiced`;
    html += `<div class="char-item ${className}" title="${title}">${char}</div>`;
  }

  html += '</div>';
  container.innerHTML = html;

  // Update mastery count
  const masteredCount = Object.keys(charStats).filter(char => {
    const stats = charStats[char];
    return stats && stats.total >= 3 && (stats.correct / stats.total) >= 0.85;
  }).length;
  document.getElementById("totalMastered").textContent = masteredCount;
  document.getElementById("lessonsCompleted").textContent = lesson;
}

function updatePracticeHistoryDisplay() {
  const historyChart = document.getElementById("historyChart");
  const today = new Date();
  let html = '';

  for (let i = 6; i >= 0; i--) {
    const date = new Date(today);
    date.setDate(date.getDate() - i);
    const dateStr = date.toISOString().split('T')[0];

    const dayData = sessionHistory.filter(session => session.date === dateStr);
    const totalAccuracy = dayData.length > 0 ?
      dayData.reduce((sum, session) => sum + session.accuracy, 0) / dayData.length : 0;

    const height = Math.max(5, (totalAccuracy / 100) * 45);
    const className = dayData.length > 0 ? "history-day active" : "history-day";

    html += `<div class="${className}" style="height: ${height}px;" title="${dateStr}: ${Math.round(totalAccuracy)}% avg accuracy"></div>`;
  }

  historyChart.innerHTML = html;
}

function updateLessonRoadmapDisplay() {
  const roadmapContainer = document.getElementById("lessonRoadmap");
  let html = '<div class="lesson-roadmap">';

  // Show lessons around current lesson
  const startLesson = Math.max(0, lesson - 2);
  const endLesson = Math.min(lessons.length - 1, lesson + 5);

  for (let i = startLesson; i <= endLesson; i++) {
    let className = "lesson-upcoming";
    if (i < lesson) className = "lesson-completed";
    else if (i === lesson) className = "lesson-current";

    html += `<div class="lesson-item ${className}">L${i + 1}</div>`;
  }

  html += '</div>';
  roadmapContainer.innerHTML = html;

  // Update next characters
  if (lesson < lessons.length - 1) {
    const nextLessonChars = lessons[lesson + 1];
    const currentChars = lessons[lesson];
    const newChars = nextLessonChars.filter(char => !currentChars.includes(char));
    document.getElementById("nextChars").textContent = newChars.join(", ") || "None";
  } else {
    document.getElementById("nextChars").textContent = "Course Complete!";
  }
}

// Reset progress functionality
function resetProgress() {
  if (confirm("Are you sure you want to reset all progress? This action cannot be undone.\n\nThis will:\n‚Ä¢ Reset to lesson 1\n‚Ä¢ Clear all character statistics\n‚Ä¢ Remove session history\n‚Ä¢ Reset WPM to default")) {
    // Clear localStorage
    localStorage.removeItem("lesson");
    localStorage.removeItem("charStats");
    localStorage.removeItem("sessionHistory");
    localStorage.removeItem("overallWPM");

    // Reset global variables
    lesson = 2; // Lesson 3 (K,M,R,S)
    correct = 0;
    total = 0;
    overallWPM = 8;
    charStats = {};
    sessionHistory = [];
    farnsworthCharSpacing = (60 / (overallWPM * 5)) - (60 / (characterWPM * 5));

    // Update UI
    updateLesson();
    updateWPMDisplay();
    updateCharacterKeyboard();
    updateProgressContent();

    // Close drawer and show success message
    toggleProgressDrawer();
    document.getElementById("output").textContent = "‚úÖ Progress reset! Starting fresh from lesson 1.";
  }
}

// Event listeners for progress drawer
document.getElementById("progressToggle").onclick = toggleProgressDrawer;
document.getElementById("closeProgress").onclick = toggleProgressDrawer;
document.getElementById("progressOverlay").onclick = toggleProgressDrawer;
document.getElementById("resetProgress").onclick = resetProgress;
</script>
</body>
</html>
